#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR={{backup_work}}/{{item.name}}

{% if item.source.startswith('postgresql://') %}

DBNAME={{item.source.split('postgresql://')[-1]}}
pg_dump -U {{backup_postgres_user}} {{ '-h ' + backup_postgres_host  if backup_postgres_host else ''}} {{ ('-p %s' % backup_postgres_port)  if backup_postgres_port else ''}} -c $DBNAME -f ${WORKDIR}/dump

{% elif item.source.startswith('mysql://') %}

DBNAME={{item.source.split('mysql://')[-1]}}
mysqldump -u {{backup_mysql_user}} -p{{backup_mysql_pass}} $DBNAME  > ${WORKDIR}/dump

{% elif item.source.startswith('mongo://') %}

{% if item.source == 'mongo://' %}
# Dump all databases
mongodump -u {{backup_mongo_user}} -p {{backup_mongo_pass}} -h {{backup_mongo_host}} --port {{backup_mongo_port}} --out $WORKDIR/dump
{% else %}
# Dump the passed database
DBNAME={{item.source.split('/')[-1]}}
mongodump -u {{backup_mongo_user}} -p {{backup_mongo_pass}} -h {{backup_mongo_host}} --port {{backup_mongo_port}} -d $DBNAME --out $WORKDIR/dump
{% endif %}

{% endif %}

{% for action in item.pre_actions|default([]) %}
{{ action }}
{% endfor %}
